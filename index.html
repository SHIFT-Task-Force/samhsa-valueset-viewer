<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMHSA ValueSet Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 20px;
            margin: 30px;
            border-radius: 6px;
            border: 1px solid #bee5eb;
        }
        
        .info h3 {
            margin-bottom: 10px;
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #495057;
        }
        
        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        th::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }
        
        th.sorted-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }
        
        th.sorted-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-active {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unknown {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            background: #e2e3e5;
            color: #383d41;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .export-buttons {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• SAMHSA ValueSet Viewer</h1>
            <p>Explore and analyze FHIR ValueSets from SAMHSA using tx.fhir.org</p>
        </header>
        
        <div class="controls">
            <div class="form-group">
                <label for="valuesetSelect">Select a SAMHSA ValueSet:</label>
                <select id="valuesetSelect">
                    <option value="">-- Choose a ValueSet --</option>
                    <option value="2.16.840.1.113762.1.4.1142.1">2.16.840.1.113762.1.4.1142.1 - Alcohol Use Disorders (SNOMEDCD)</option>
                    <option value="2.16.840.1.113762.1.4.1142.2">2.16.840.1.113762.1.4.1142.2 - Alcohol Use Disorders (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.3">2.16.840.1.113762.1.4.1142.3 - Alcohol Use Disorders (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.4">2.16.840.1.113762.1.4.1142.4 - Alcohol Use Disorders (ICD10CD)</option>
                    <option value="2.16.840.1.113762.1.4.1142.5">2.16.840.1.113762.1.4.1142.5 - Alcohol Use Disorders (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.6">2.16.840.1.113762.1.4.1142.6 - Amphetamine Use Disorders (HCPCS)</option>
                    <option value="2.16.840.1.113762.1.4.1142.7">2.16.840.1.113762.1.4.1142.7 - Amphetamine Use Disorders (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.8">2.16.840.1.113762.1.4.1142.8 - Amphetamine Use Disorders (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.9">2.16.840.1.113762.1.4.1142.9 - Amphetamine Use Disorders (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.10">2.16.840.1.113762.1.4.1142.10 - Amphetamine Use Disorders (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.11">2.16.840.1.113762.1.4.1142.11 - Amphetamine Use Disorders (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.12">2.16.840.1.113762.1.4.1142.12 - Cannabis Use Disorders (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.13">2.16.840.1.113762.1.4.1142.13 - Cannabis Use Disorders (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.14">2.16.840.1.113762.1.4.1142.14 - Cannabis Use Disorders (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.15">2.16.840.1.113762.1.4.1142.15 - Cannabis Use Disorders (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.16">2.16.840.1.113762.1.4.1142.16 - Cocaine Use Disorder (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.17">2.16.840.1.113762.1.4.1142.17 - Cocaine Use Disorder (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.18">2.16.840.1.113762.1.4.1142.18 - Cocaine Use Disorder (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.19">2.16.840.1.113762.1.4.1142.19 - Hallucinogens (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.20">2.16.840.1.113762.1.4.1142.20 - Hallucinogens (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.21">2.16.840.1.113762.1.4.1142.21 - Hallucinogens (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.22">2.16.840.1.113762.1.4.1142.22 - Hallucinogens (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.23">2.16.840.1.113762.1.4.1142.23 - HIV/AIDS Information (HCPCS)</option>
                    <option value="2.16.840.1.113762.1.4.1142.24">2.16.840.1.113762.1.4.1142.24 - HIV/AIDS Information (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.25">2.16.840.1.113762.1.4.1142.25 - HIV/AIDS Information (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.26">2.16.840.1.113762.1.4.1142.26 - HIV/AIDS Information (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.27">2.16.840.1.113762.1.4.1142.27 - HIV/AIDS Information (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.28">2.16.840.1.113762.1.4.1142.28 - Inhalants (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.29">2.16.840.1.113762.1.4.1142.29 - Inhalants (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.30">2.16.840.1.113762.1.4.1142.30 - Inhalants (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.31">2.16.840.1.113762.1.4.1142.31 - undefined 31</option>
                    <option value="2.16.840.1.113762.1.4.1142.32">2.16.840.1.113762.1.4.1142.32 - Mental Health Disorders (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.33">2.16.840.1.113762.1.4.1142.33 - Mental Health Disorders (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.34">2.16.840.1.113762.1.4.1142.34 - Mental Health Disorders (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.35">2.16.840.1.113762.1.4.1142.35 - Mental Health Disorders (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.36">2.16.840.1.113762.1.4.1142.36 - Mental Health Disorders (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.37">2.16.840.1.113762.1.4.1142.37 - Undefined 37</option>
                    <option value="2.16.840.1.113762.1.4.1142.38">2.16.840.1.113762.1.4.1142.38 - Opioids (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.39">2.16.840.1.113762.1.4.1142.39 - Opioids (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.40">2.16.840.1.113762.1.4.1142.40 - Opioids (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.41">2.16.840.1.113762.1.4.1142.41 - Opioids (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.42">2.16.840.1.113762.1.4.1142.42 - Opioids (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.43">2.16.840.1.113762.1.4.1142.43 - Other Psychoactive Substance (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.44">2.16.840.1.113762.1.4.1142.44 - Other Psychoactive Substance (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.45">2.16.840.1.113762.1.4.1142.45 - Other Psychoactive Substance (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.46">2.16.840.1.113762.1.4.1142.46 - Sedative Hypnotic (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.47">2.16.840.1.113762.1.4.1142.47 - Sedative Hypnotic (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.48">2.16.840.1.113762.1.4.1142.48 - Sedative Hypnotic (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.49">2.16.840.1.113762.1.4.1142.49 - Sexuality and Reproductive Health (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.50">2.16.840.1.113762.1.4.1142.50 - Sexuality and Reproductive Health (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.51">2.16.840.1.113762.1.4.1142.51 - C2S Tobacco Use Disorders (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.52">2.16.840.1.113762.1.4.1142.52 - C2S Tobacco Use Disorders (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.53">2.16.840.1.113762.1.4.1142.53 - C2S Tobacco Use Disorders (ICD10CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.54">2.16.840.1.113762.1.4.1142.54 - C2S Tobacco Use Disorders (ICD9CM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.55">2.16.840.1.113762.1.4.1142.55 - Substance Use Information (HCPCS)</option>
                    <option value="2.16.840.1.113762.1.4.1142.56">2.16.840.1.113762.1.4.1142.56 - Substance Use Information (LOINC)</option>
                    <option value="2.16.840.1.113762.1.4.1142.57">2.16.840.1.113762.1.4.1142.57 - Substance Use Information (RXNORM)</option>
                    <option value="2.16.840.1.113762.1.4.1142.58">2.16.840.1.113762.1.4.1142.58 - Master Sensitive Codes ValueSet</option>
                    <option value="2.16.840.1.113762.1.4.1142.59">2.16.840.1.113762.1.4.1142.59 - Opioids (CPT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.60">2.16.840.1.113762.1.4.1142.60 - HIV/AIDS Information (CPT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.61">2.16.840.1.113762.1.4.1142.61 - Undefined 61</option>
                    <option value="2.16.840.1.113762.1.4.1142.62">2.16.840.1.113762.1.4.1142.62 - Undefined 62</option>
                    <option value="2.16.840.1.113762.1.4.1142.63">2.16.840.1.113762.1.4.1142.63 - Undefined 63</option>
                    <option value="2.16.840.1.113762.1.4.1142.64">2.16.840.1.113762.1.4.1142.64 - Undefined 64</option>
                    <option value="2.16.840.1.113762.1.4.1142.65">2.16.840.1.113762.1.4.1142.65 - Test Alcohol Use Disorders (SNOMED-CT)</option>
                    <option value="2.16.840.1.113762.1.4.1142.66">2.16.840.1.113762.1.4.1142.66 - Undefined 66</option>
                    <option value="2.16.840.1.113762.1.4.1142.67">2.16.840.1.113762.1.4.1142.67 - Test HIV/AIDS Information (SNOMEDCD)</option>
                </select>
            </div>
            
            <button id="fetchBtn" onclick="fetchValueSet()">üîç Fetch ValueSet</button>
            <button class="btn-secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button class="btn-secondary" onclick="checkAllSizes()">üìä Check All Sizes</button>
        </div>
        
        <div id="loadingDiv" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div>Loading ValueSet data...</div>
        </div>
        
        <div id="errorDiv" class="error" style="display: none;"></div>
        
        <div id="sizesDiv" style="display: none;"></div>
        
        <div id="resultsDiv" style="display: none;">
            <div class="table-container">
                <div class="export-buttons">
                    <button onclick="exportToCSV()">üì• Export to CSV</button>
                </div>
                
                <div class="stats" id="statsDiv"></div>
                
                <div class="filter-container">
                    <div class="form-group">
                        <label for="filterSystem">Filter by System:</label>
                        <input type="text" id="filterSystem" placeholder="e.g., snomed" onkeyup="filterTable()">
                    </div>
                    <div class="form-group">
                        <label for="filterCode">Filter by Code:</label>
                        <input type="text" id="filterCode" placeholder="e.g., 123456" onkeyup="filterTable()">
                    </div>
                    <div class="form-group">
                        <label for="filterDisplay">Filter by Display:</label>
                        <input type="text" id="filterDisplay" placeholder="e.g., disorder" onkeyup="filterTable()">
                    </div>
                </div>
                
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">System</th>
                            <th onclick="sortTable(1)">Version</th>
                            <th onclick="sortTable(2)">Code</th>
                            <th onclick="sortTable(3)">Active Status</th>
                            <th onclick="sortTable(4)">Display</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="info">
            <h3>‚ÑπÔ∏è About This Tool</h3>
            <p>This tool retrieves and displays expanded FHIR ValueSets from tx.fhir.org. Select a SAMHSA ValueSet from the dropdown above and click "Fetch ValueSet" to view its contents.</p>
            <p style="margin-top: 10px;"><strong>Features:</strong></p>
            <ul style="margin-left: 20px; margin-top: 5px;">
                <li>View all codes in a ValueSet with their system, version (shortened for readability), code, active status, and display name</li>
                <li>Sort by any column by clicking on the column header</li>
                <li>Filter codes by system, code, or display text</li>
                <li>Export data to CSV format</li>
                <li>View statistics about the ValueSet (total codes, active/inactive counts, systems used)</li>
                <li>Compare all ValueSets to find the largest one using "Check All Sizes"</li>
                <li>Detailed error logging in browser console for troubleshooting</li>
                <li>Handles both FHIR Bundle and direct ValueSet responses</li>
            </ul>
            <p style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">
                <strong>Technical Details:</strong> This application was developed by GitHub Copilot (Claude Sonnet 4.5) to provide an intuitive interface for exploring SAMHSA FHIR ValueSets. It uses the tx.fhir.org FHIR terminology server to retrieve ValueSet expansions via HTTPS requests with JSON formatting.
            </p>
        </div>
    </div>
    
    <script>
        let currentData = [];
        let sortDirection = {};
        
        async function fetchValueSet() {
            const select = document.getElementById('valuesetSelect');
            const oid = select.value;
            
            if (!oid) {
                const errorDiv = document.getElementById('errorDiv');
                errorDiv.textContent = '‚ö† Please select a ValueSet first';
                errorDiv.style.display = 'block';
                return;
            }
            
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            const sizesDiv = document.getElementById('sizesDiv');
            const fetchBtn = document.getElementById('fetchBtn');
            
            // Reset displays
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            sizesDiv.style.display = 'none';
            fetchBtn.disabled = true;
            
            const url = `https://tx.fhir.org/r4/ValueSet/?url=http://cts.nlm.nih.gov/fhir/ValueSet/${oid}&_format=json`;
            
            console.log('=== HTTP REQUEST DETAILS ===');
            console.log('Request URL:', url);
            console.log('Request Method: GET');
            console.log('Request Time:', new Date().toISOString());
            
            try {
                const response = await fetch(url);
                
                console.log('\n=== HTTP RESPONSE DETAILS ===');
                console.log('Response Status:', response.status, response.statusText);
                console.log('Response OK:', response.ok);
                console.log('Response Headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`  ${key}: ${value}`);
                }
                
                // Clone response so we can read it twice
                const responseClone = response.clone();
                const responseText = await responseClone.text();
                
                console.log('\n=== RAW RESPONSE BODY ===');
                console.log(responseText);
                
                if (!response.ok) {
                    let errorDetails = `HTTP ${response.status} ${response.statusText}\n\n`;
                    errorDetails += `Request URL: ${url}\n\n`;
                    errorDetails += `Response Body:\n${responseText.substring(0, 1000)}${responseText.length > 1000 ? '...(truncated)' : ''}`;
                    
                    errorDiv.innerHTML = `
                        <strong>HTTP Error Details:</strong><br>
                        <pre style="white-space: pre-wrap; margin-top: 10px; font-family: monospace; max-height: 400px; overflow: auto;">${errorDetails}</pre>
                    `;
                    errorDiv.style.display = 'block';
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('\n=== PARSED JSON DATA ===');
                console.log('Resource Type:', data.resourceType);
                
                // Handle FHIR Bundle response
                let valueSet = null;
                if (data.resourceType === 'Bundle' && data.entry && data.entry.length > 0) {
                    console.log('Response is a Bundle with', data.entry.length, 'entries');
                    valueSet = data.entry[0].resource;
                    console.log('Extracted ValueSet from Bundle entry[0]');
                } else if (data.resourceType === 'ValueSet') {
                    console.log('Response is a direct ValueSet');
                    valueSet = data;
                } else {
                    console.log('Unexpected response structure');
                }
                
                if (valueSet) {
                    console.log('ValueSet Resource Type:', valueSet.resourceType);
                    console.log('Has expansion:', !!valueSet.expansion);
                    console.log('Has expansion.contains:', !!(valueSet.expansion && valueSet.expansion.contains));
                    if (valueSet.expansion && valueSet.expansion.contains) {
                        console.log('Number of codes:', valueSet.expansion.contains.length);
                    }
                }
                console.log('Full Data Object:', data);
                
                if (valueSet && valueSet.resourceType === 'ValueSet' && valueSet.expansion && valueSet.expansion.contains) {
                    currentData = valueSet.expansion.contains;
                    displayResults(currentData);
                    displayStats(currentData, valueSet);
                    resultsDiv.style.display = 'block';
                } else {
                    let errorDetails = `Response Structure Issue\n\n`;
                    errorDetails += `Response Type: ${data.resourceType || 'undefined'}\n`;
                    if (data.resourceType === 'Bundle') {
                        errorDetails += `Bundle entries: ${data.entry ? data.entry.length : 0}\n`;
                        if (data.entry && data.entry.length > 0) {
                            errorDetails += `First entry resource type: ${data.entry[0].resource?.resourceType || 'undefined'}\n`;
                        }
                    }
                    if (valueSet) {
                        errorDetails += `ValueSet has expansion: ${!!valueSet.expansion}\n`;
                        errorDetails += `ValueSet has expansion.contains: ${!!(valueSet.expansion && valueSet.expansion.contains)}\n`;
                    }
                    errorDetails += `\nFull Response:\n${JSON.stringify(data, null, 2).substring(0, 2000)}${JSON.stringify(data).length > 2000 ? '...(truncated)' : ''}`;
                    
                    errorDiv.innerHTML = `
                        <strong>Data Structure Error:</strong><br>
                        <pre style="white-space: pre-wrap; margin-top: 10px; font-family: monospace; max-height: 400px; overflow: auto;">${errorDetails}</pre>
                    `;
                    errorDiv.style.display = 'block';
                    throw new Error('No expansion data found in the ValueSet response');
                }
            } catch (error) {
                // Display detailed error information
                let errorMessage = `Error: ${error.message}\n\n`;
                errorMessage += `Request URL: ${url}\n`;
                errorMessage += `Time: ${new Date().toISOString()}\n`;
                
                // Add more details if available
                if (error.stack) {
                    errorMessage += '\n\nStack Trace:\n' + error.stack;
                }
                
                // Check if it's a network error
                if (!navigator.onLine) {
                    errorMessage += '\n\nNote: You appear to be offline.';
                } else if (error.name === 'TypeError') {
                    errorMessage += '\n\nNote: This may be a network error or CORS issue.';
                }
                
                if (!errorDiv.innerHTML) {  // Only set if not already set above
                    errorDiv.innerHTML = `
                        <strong>Error Details:</strong><br>
                        <pre style="white-space: pre-wrap; margin-top: 10px; font-family: monospace; max-height: 400px; overflow: auto;">${errorMessage}</pre>
                    `;
                }
                errorDiv.style.display = 'block';
                
                // Log full error details to console
                console.error('\n=== ERROR DETAILS ===');
                console.error('Full Error Object:', error);
                console.error('Error Name:', error.name);
                console.error('Error Message:', error.message);
                console.error('Error Stack:', error.stack);
            } finally {
                loadingDiv.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }
        
        function displayResults(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = tbody.insertRow();
                
                // System
                const systemCell = row.insertCell();
                systemCell.textContent = item.system || 'N/A';
                
                // Version
                const versionCell = row.insertCell();
                let version = item.version || 'N/A';
                // Shorten version URLs to just show the last part (e.g., /20250901)
                if (version.includes('/')) {
                    version = '/' + version.split('/').pop();
                }
                versionCell.textContent = version;
                
                // Code
                const codeCell = row.insertCell();
                const codeElement = document.createElement('code');
                codeElement.textContent = item.code || 'N/A';
                codeCell.appendChild(codeElement);
                
                // Active status
                const activeCell = row.insertCell();
                const statusSpan = document.createElement('span');
                if (item.inactive === true) {
                    statusSpan.className = 'status-inactive';
                    statusSpan.textContent = 'Inactive';
                } else if (item.inactive === false) {
                    statusSpan.className = 'status-active';
                    statusSpan.textContent = 'Active';
                } else {
                    statusSpan.className = 'status-unknown';
                    statusSpan.textContent = 'Unknown';
                }
                activeCell.appendChild(statusSpan);
                
                // Display
                const displayCell = row.insertCell();
                displayCell.textContent = item.display || 'N/A';
            });
        }
        
        function displayStats(data, fullData) {
            const statsDiv = document.getElementById('statsDiv');
            const totalCodes = data.length;
            const activeCodes = data.filter(item => item.inactive === false).length;
            const inactiveCodes = data.filter(item => item.inactive === true).length;
            const systems = [...new Set(data.map(item => item.system))];
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h4>Total Codes</h4>
                    <div class="value">${totalCodes}</div>
                </div>
                <div class="stat-card">
                    <h4>Active Codes</h4>
                    <div class="value">${activeCodes}</div>
                </div>
                <div class="stat-card">
                    <h4>Inactive Codes</h4>
                    <div class="value">${inactiveCodes}</div>
                </div>
                <div class="stat-card">
                    <h4>Code Systems</h4>
                    <div class="value">${systems.length}</div>
                </div>
            `;
        }
        
        function sortTable(columnIndex) {
            const table = document.getElementById('resultsTable');
            const thead = table.querySelector('thead');
            const ths = thead.querySelectorAll('th');
            
            // Remove sorted classes from all headers
            ths.forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const key = columnIndex;
            const currentDirection = sortDirection[key] || 'none';
            
            let newDirection;
            if (currentDirection === 'none' || currentDirection === 'desc') {
                newDirection = 'asc';
            } else {
                newDirection = 'desc';
            }
            
            sortDirection[key] = newDirection;
            ths[columnIndex].classList.add(`sorted-${newDirection}`);
            
            const multiplier = newDirection === 'asc' ? 1 : -1;
            
            const sortedData = [...currentData].sort((a, b) => {
                let aVal, bVal;
                
                switch(columnIndex) {
                    case 0: // System
                        aVal = a.system || '';
                        bVal = b.system || '';
                        break;
                    case 1: // Version
                        aVal = a.version || '';
                        bVal = b.version || '';
                        break;
                    case 2: // Code
                        aVal = a.code || '';
                        bVal = b.code || '';
                        break;
                    case 3: // Display
                        aVal = a.display || '';
                        bVal = b.display || '';
                        break;
                    case 4: // Active status
                        aVal = a.inactive === true ? 2 : (a.inactive === false ? 1 : 3);
                        bVal = b.inactive === true ? 2 : (b.inactive === false ? 1 : 3);
                        break;
                }
                
                if (typeof aVal === 'string') {
                    return multiplier * aVal.localeCompare(bVal);
                } else {
                    return multiplier * (aVal - bVal);
                }
            });
            
            displayResults(sortedData);
        }
        
        function filterTable() {
            const systemFilter = document.getElementById('filterSystem').value.toLowerCase();
            const codeFilter = document.getElementById('filterCode').value.toLowerCase();
            const displayFilter = document.getElementById('filterDisplay').value.toLowerCase();
            
            const filteredData = currentData.filter(item => {
                const systemMatch = !systemFilter || (item.system || '').toLowerCase().includes(systemFilter);
                const codeMatch = !codeFilter || (item.code || '').toLowerCase().includes(codeFilter);
                const displayMatch = !displayFilter || (item.display || '').toLowerCase().includes(displayFilter);
                
                return systemMatch && codeMatch && displayMatch;
            });
            
            displayResults(filteredData);
        }
        
        function clearResults() {
            document.getElementById('resultsDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'none';
            document.getElementById('valuesetSelect').value = '';
            document.getElementById('filterSystem').value = '';
            document.getElementById('filterCode').value = '';
            document.getElementById('filterDisplay').value = '';
            currentData = [];
        }
        
        function exportToCSV() {
            const headers = ['System', 'Version', 'Code', 'Display', 'Active Status'];
            const rows = currentData.map(item => [
                item.system || '',
                item.version || '',
                item.code || '',
                item.display || '',
                item.inactive === true ? 'Inactive' : (item.inactive === false ? 'Active' : 'Unknown')
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'valueset-export.csv', 'text/csv');
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Allow Enter key to trigger fetch
        document.getElementById('valuesetSelect').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                fetchValueSet();
            }
        });
        
        async function checkAllSizes() {
            const select = document.getElementById('valuesetSelect');
            const options = Array.from(select.options).filter(opt => opt.value !== '');
            
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            const sizesDiv = document.getElementById('sizesDiv');
            const fetchBtn = document.getElementById('fetchBtn');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            sizesDiv.style.display = 'none';
            fetchBtn.disabled = true;
            
            const results = [];
            
            console.log('=== CHECKING ALL VALUESET SIZES ===');
            console.log('Total ValueSets to check:', options.length);
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                const oid = option.value;
                const name = option.textContent;
                
                loadingDiv.innerHTML = `<div class="spinner"></div><div>Checking ${i + 1} of ${options.length}: ${name}</div>`;
                
                try {
                    const url = `https://tx.fhir.org/r4/ValueSet/?url=http://cts.nlm.nih.gov/fhir/ValueSet/${oid}&_format=json`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const data = await response.json();
                        let valueSet = null;
                        
                        if (data.resourceType === 'Bundle' && data.entry && data.entry.length > 0) {
                            valueSet = data.entry[0].resource;
                        } else if (data.resourceType === 'ValueSet') {
                            valueSet = data;
                        }
                        
                        if (valueSet && valueSet.expansion && valueSet.expansion.contains) {
                            const count = valueSet.expansion.contains.length;
                            results.push({ oid, name, count });
                            console.log(`${name}: ${count} codes`);
                        } else {
                            results.push({ oid, name, count: 0, error: 'No expansion' });
                            console.log(`${name}: No expansion found`);
                        }
                    } else {
                        results.push({ oid, name, count: 0, error: `HTTP ${response.status}` });
                        console.log(`${name}: HTTP ${response.status}`);
                    }
                } catch (error) {
                    results.push({ oid, name, count: 0, error: error.message });
                    console.log(`${name}: Error - ${error.message}`);
                }
                
                // Small delay to avoid overwhelming the server
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Sort by count descending
            results.sort((a, b) => b.count - a.count);
            
            console.log('\n=== RESULTS SORTED BY SIZE ===');
            results.forEach((r, i) => {
                console.log(`${i + 1}. ${r.name}: ${r.count} codes${r.error ? ` (${r.error})` : ''}`);
            });
            
            // Display results in a table
            const largestMsg = `<div style="background: #d4edda; color: #155724; padding: 15px; margin: 20px 30px; border-radius: 6px; border-left: 4px solid #28a745;">
                <strong>‚úì Analysis Complete!</strong><br>
                Largest ValueSet: ${results[0].name.replace(results[0].oid + ' - ', '')}<br>
                Code Count: ${results[0].count.toLocaleString()}
            </div>`;
            
            const tableHtml = `
                ${largestMsg}
                <h3 style="margin: 20px 30px 10px;">ValueSet Sizes (Sorted by Count)</h3>
                <div style="padding: 0 30px 30px; overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 12px; text-align: left;">Rank</th>
                                <th style="padding: 12px; text-align: left;">OID</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: right;">Code Count</th>
                                <th style="padding: 12px; text-align: left;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map((r, i) => `
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 12px;">${i + 1}</td>
                                    <td style="padding: 12px;"><code>${r.oid}</code></td>
                                    <td style="padding: 12px;">${r.name.replace(r.oid + ' - ', '')}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: bold;">${r.count.toLocaleString()}</td>
                                    <td style="padding: 12px;">${r.error ? `<span style="color: #dc3545;">${r.error}</span>` : '<span style="color: #28a745;">‚úì</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            sizesDiv.innerHTML = tableHtml;
            sizesDiv.style.display = 'block';
            loadingDiv.style.display = 'none';
            fetchBtn.disabled = false;
        }
    </script>
</body>
</html>
